---
layout: post
title: "Evaluating group acoustic signatures using cross-correlation"
date: 13-08-2019
editor_options: 
  chunk_output_type: console
---



Social learning is often diagnosed by mapping the geographic variation of behavior. Behavioral variation at a small geographical scale that shows both sharp differences among localities and consistency within localities is indicative of social learning of local traditions. This pattern translates into a pretty straight forward statistical hypothesis: *the behavior is more similar within than between groups* (although absence of this pattern doesn't necessarily imply a lack of learning!). In other words, if there is social learning going on, we can expect a group level signature. 

This post is about how to test this pattern in vocal signals (i.e. testing vocal learning) using pairwise similarities derived from spectrographic cross-correlation. In fact, that's exactly what we did in [our recent paper on the co-ocurrence of social learning in vocal and visual signals in the long billed hermit](https://marceloarayasalas.weebly.com/uploads/2/5/5/2/25524573/araya-salas_smith-vidaurre_et_al_2019.pdf). So the post reproduces the code I used for the acoustic analysis in that paper.

Male long-billed hermits have a vocal repertoire consisting of a single song type. Different song types are found at different sites, leks and even within leks:
<img src="/./img/map.lbh.song.types.png" title="plot of chunk song 1" alt="plot of chunk song 1" width="600px" style="display: block; margin: auto;" />
<font size="2">Location of three study sites in northeastern Costa Rica. Spectrograms of the 10 observed song types grouped by lek are also shown. Maps of leks at La Selva Biological Station are shown in greater detail in the lower left map. The two song neighbourhoods at lek SUR are shown in lower right map (similar song neighbourhoods were found at the other leks with 2 song types—SJA, TR2, and HC1—but are not shown); polygons represent lekking male territories and the coloured borders delineate the song neighbourhoods corresponding to the coloured borders of the spectrograms at the far right.</font>

All annotations and acoustic data were made [available on Dryad](https://datadryad.org/resource/doi:10.5061/dryad.gn8qf6q). We just need to download the extended selection table ([R object including acoustic data + annotations](https://marce10.github.io/2018/05/15/Extended_selection_tables.html)) from Dryad and unzip the file as follows (it could take a while): 

{% highlight r %}
# set temporary working directory
setwd(tempdir())

url <- "https://datadryad.org/bitstream/handle/10255/dryad.216487/extended%20selection%20table%20LBH%20songs.zip?sequence=2"

download.file(url = url, destfile = "lbh_est.zip", mode="wb")

unzip("lbh_est.zip")
{% endhighlight %}

Now we can read the file and take a look at the data:

{% highlight r %}
library(warbleR)

lbh_est <- readRDS("extended selection table LBH songs.RDS")

lbh_est
{% endhighlight %}


{% highlight text %}
## object of class 'extended_selection_table' 
##  contains a selection table data frame with 7646 rows and 14 columns: 
##                  sound.files selec start     end comm bottom.freq top.freq
## 1 0.HC1.2013.6.9.10.08.WAV_1     1   0.1 0.25607    A    1.949272 10.74741
## 2 0.HC1.2013.6.9.10.08.WAV_2     1   0.1 0.25607    A    1.949272 10.74741
## 3 0.HC1.2013.6.9.10.08.WAV_3     1   0.1 0.25607    A    1.949272 10.74741
## 4 0.HC1.2013.6.9.10.08.WAV_4     1   0.1 0.25607    A    1.949272 10.74741
## 5 0.HC1.2013.6.9.10.08.WAV_5     1   0.1 0.25607    A    1.949272 10.74741
## 6 0.HC1.2013.6.9.10.08.WAV_6     1   0.1 0.25607    A    1.949272 10.74741
##              file.name tailored song.type Lek Bird.ID old.selec
## 1 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
## 2 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
## 3 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
## 4 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
## 5 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
## 6 0.HC1.2013.6.9.10.08        y         A HC1  Male17   1+AC0-1
##   lek.song.type
## 1         HC1-A
## 2         HC1-A
## 3         HC1-A
## 4         HC1-A
## 5         HC1-A
## 6         HC1-A
## ... and 7640 more rows 
## 7646 wave objects (as attributes): 
## [1] "0.HC1.2013.6.9.10.08.WAV_1" "0.HC1.2013.6.9.10.08.WAV_2"
## [3] "0.HC1.2013.6.9.10.08.WAV_3" "0.HC1.2013.6.9.10.08.WAV_4"
## [5] "0.HC1.2013.6.9.10.08.WAV_5" "0.HC1.2013.6.9.10.08.WAV_6"
## ... and 7640 more 
## and a data frame (check.results) generated by checkres() (as attribute) 
## the selection table was created by element (see 'class_extended_selection_table')
{% endhighlight %}


The data contains several songs per individual, and several individuals per lek. This is a pretty big data set, so it takes a while to run the analysis. To speed it up a bit (and avoid pseudoreplication!), we will keep only the highest signal-to-noise ratio song for each individual:



{% highlight r %}
# set warbleR global options 
warbleR_options(wl = 200)

# measure SNR
lbh_est <- sig2noise(lbh_est, mar = 0.1)

# subset ext. sel. tab.
sub_lbh_est <- lbh_est[ave(x = lbh_est$SNR, paste0(lbh_est$Lek, lbh_est$Bird.ID), FUN = function(x) rank(x, ties.method = "first")) == 1, ]
{% endhighlight %}


Now we can run the cross-correlation analysis as follows:



{% highlight r %}
xc_mat <- x_corr(sub_lbh_est)
{% endhighlight %}

The output is a similarity matrix with dimensions *60 x 60* (for simplicity only the 20 first columns/rows are shown):
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:740px;  font-size: 12px; margin-left: auto; margin-right: auto;" class="table table-striped"><table>
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.10.08.WAV_7-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.7.20.WAV_73-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.7.31.WAV_218-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.7.50.WAV_334-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.8.09.WAV_605-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.8.18.WAV_635-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.8.28.WAV_815-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.8.49.WAV_835-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.8.53.WAV_935-1 </th>
   <th style="text-align:center;"> 0.HC1.2013.6.9.9.58.WAV_1016-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.16.8.53.WAV_1161-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.16.8.59.WAV_1197-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.16.9.25.WAV_1281-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.8.49.WAV_1301-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.9.00.WAV_1501-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.9.02.WAV_1528-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.9.05.WAV_1639-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.9.09.WAV_1657-1 </th>
   <th style="text-align:center;"> 0.TR2.2013.4.17.9.18.WAV_1722-1 </th>
   <th style="text-align:center;"> 108.LOC.2013.3.26.8.15.WAV_1810-1 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.10.08.WAV_7-1 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6318207 </td>
   <td style="text-align:center;"> 0.6395940 </td>
   <td style="text-align:center;"> 0.5593399 </td>
   <td style="text-align:center;"> 0.6805133 </td>
   <td style="text-align:center;"> 0.6612055 </td>
   <td style="text-align:center;"> 0.6413484 </td>
   <td style="text-align:center;"> 0.6925945 </td>
   <td style="text-align:center;"> 0.6602419 </td>
   <td style="text-align:center;"> 0.7120209 </td>
   <td style="text-align:center;"> 0.6988743 </td>
   <td style="text-align:center;"> 0.5154483 </td>
   <td style="text-align:center;"> 0.3852950 </td>
   <td style="text-align:center;"> 0.3887604 </td>
   <td style="text-align:center;"> 0.3956447 </td>
   <td style="text-align:center;"> 0.3914653 </td>
   <td style="text-align:center;"> 0.4883395 </td>
   <td style="text-align:center;"> 0.5111078 </td>
   <td style="text-align:center;"> 0.5291018 </td>
   <td style="text-align:center;"> 0.3778123 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.7.20.WAV_73-1 </td>
   <td style="text-align:center;"> 0.6318207 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.7549527 </td>
   <td style="text-align:center;"> 0.5453884 </td>
   <td style="text-align:center;"> 0.6666001 </td>
   <td style="text-align:center;"> 0.6651080 </td>
   <td style="text-align:center;"> 0.6188702 </td>
   <td style="text-align:center;"> 0.6963981 </td>
   <td style="text-align:center;"> 0.6680267 </td>
   <td style="text-align:center;"> 0.6382985 </td>
   <td style="text-align:center;"> 0.6041628 </td>
   <td style="text-align:center;"> 0.5440716 </td>
   <td style="text-align:center;"> 0.4152873 </td>
   <td style="text-align:center;"> 0.4516586 </td>
   <td style="text-align:center;"> 0.4823688 </td>
   <td style="text-align:center;"> 0.4294063 </td>
   <td style="text-align:center;"> 0.4274496 </td>
   <td style="text-align:center;"> 0.5107089 </td>
   <td style="text-align:center;"> 0.4603019 </td>
   <td style="text-align:center;"> 0.4668047 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.7.31.WAV_218-1 </td>
   <td style="text-align:center;"> 0.6395940 </td>
   <td style="text-align:center;"> 0.7549527 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.5139641 </td>
   <td style="text-align:center;"> 0.6412724 </td>
   <td style="text-align:center;"> 0.6759948 </td>
   <td style="text-align:center;"> 0.6116239 </td>
   <td style="text-align:center;"> 0.7109725 </td>
   <td style="text-align:center;"> 0.6937609 </td>
   <td style="text-align:center;"> 0.6524545 </td>
   <td style="text-align:center;"> 0.6634098 </td>
   <td style="text-align:center;"> 0.4918568 </td>
   <td style="text-align:center;"> 0.3583943 </td>
   <td style="text-align:center;"> 0.3840890 </td>
   <td style="text-align:center;"> 0.4247754 </td>
   <td style="text-align:center;"> 0.4013482 </td>
   <td style="text-align:center;"> 0.4408986 </td>
   <td style="text-align:center;"> 0.5238786 </td>
   <td style="text-align:center;"> 0.4610690 </td>
   <td style="text-align:center;"> 0.4186119 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.7.50.WAV_334-1 </td>
   <td style="text-align:center;"> 0.5593399 </td>
   <td style="text-align:center;"> 0.5453884 </td>
   <td style="text-align:center;"> 0.5139641 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6740783 </td>
   <td style="text-align:center;"> 0.6253236 </td>
   <td style="text-align:center;"> 0.6407732 </td>
   <td style="text-align:center;"> 0.6559050 </td>
   <td style="text-align:center;"> 0.5854950 </td>
   <td style="text-align:center;"> 0.5271568 </td>
   <td style="text-align:center;"> 0.5493029 </td>
   <td style="text-align:center;"> 0.4447484 </td>
   <td style="text-align:center;"> 0.3008320 </td>
   <td style="text-align:center;"> 0.2865991 </td>
   <td style="text-align:center;"> 0.4100052 </td>
   <td style="text-align:center;"> 0.3744821 </td>
   <td style="text-align:center;"> 0.4969475 </td>
   <td style="text-align:center;"> 0.5794219 </td>
   <td style="text-align:center;"> 0.5094645 </td>
   <td style="text-align:center;"> 0.1939822 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.8.09.WAV_605-1 </td>
   <td style="text-align:center;"> 0.6805133 </td>
   <td style="text-align:center;"> 0.6666001 </td>
   <td style="text-align:center;"> 0.6412724 </td>
   <td style="text-align:center;"> 0.6740783 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.7393590 </td>
   <td style="text-align:center;"> 0.7530821 </td>
   <td style="text-align:center;"> 0.6922189 </td>
   <td style="text-align:center;"> 0.6446156 </td>
   <td style="text-align:center;"> 0.6666892 </td>
   <td style="text-align:center;"> 0.6286261 </td>
   <td style="text-align:center;"> 0.5383962 </td>
   <td style="text-align:center;"> 0.4215058 </td>
   <td style="text-align:center;"> 0.4205059 </td>
   <td style="text-align:center;"> 0.5044780 </td>
   <td style="text-align:center;"> 0.4859131 </td>
   <td style="text-align:center;"> 0.5559871 </td>
   <td style="text-align:center;"> 0.6029589 </td>
   <td style="text-align:center;"> 0.5223915 </td>
   <td style="text-align:center;"> 0.3528862 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.8.18.WAV_635-1 </td>
   <td style="text-align:center;"> 0.6612055 </td>
   <td style="text-align:center;"> 0.6651080 </td>
   <td style="text-align:center;"> 0.6759948 </td>
   <td style="text-align:center;"> 0.6253236 </td>
   <td style="text-align:center;"> 0.7393590 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.7130804 </td>
   <td style="text-align:center;"> 0.6920142 </td>
   <td style="text-align:center;"> 0.6603407 </td>
   <td style="text-align:center;"> 0.6686209 </td>
   <td style="text-align:center;"> 0.6482925 </td>
   <td style="text-align:center;"> 0.4806526 </td>
   <td style="text-align:center;"> 0.2966543 </td>
   <td style="text-align:center;"> 0.3188955 </td>
   <td style="text-align:center;"> 0.3954393 </td>
   <td style="text-align:center;"> 0.3534321 </td>
   <td style="text-align:center;"> 0.4498219 </td>
   <td style="text-align:center;"> 0.5536003 </td>
   <td style="text-align:center;"> 0.4863099 </td>
   <td style="text-align:center;"> 0.2877853 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.8.28.WAV_815-1 </td>
   <td style="text-align:center;"> 0.6413484 </td>
   <td style="text-align:center;"> 0.6188702 </td>
   <td style="text-align:center;"> 0.6116239 </td>
   <td style="text-align:center;"> 0.6407732 </td>
   <td style="text-align:center;"> 0.7530821 </td>
   <td style="text-align:center;"> 0.7130804 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6620619 </td>
   <td style="text-align:center;"> 0.5976036 </td>
   <td style="text-align:center;"> 0.6174639 </td>
   <td style="text-align:center;"> 0.5540561 </td>
   <td style="text-align:center;"> 0.4696057 </td>
   <td style="text-align:center;"> 0.3984634 </td>
   <td style="text-align:center;"> 0.3979920 </td>
   <td style="text-align:center;"> 0.4710913 </td>
   <td style="text-align:center;"> 0.4329344 </td>
   <td style="text-align:center;"> 0.5170149 </td>
   <td style="text-align:center;"> 0.5517801 </td>
   <td style="text-align:center;"> 0.4455741 </td>
   <td style="text-align:center;"> 0.3766514 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.8.49.WAV_835-1 </td>
   <td style="text-align:center;"> 0.6925945 </td>
   <td style="text-align:center;"> 0.6963981 </td>
   <td style="text-align:center;"> 0.7109725 </td>
   <td style="text-align:center;"> 0.6559050 </td>
   <td style="text-align:center;"> 0.6922189 </td>
   <td style="text-align:center;"> 0.6920142 </td>
   <td style="text-align:center;"> 0.6620619 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.7922522 </td>
   <td style="text-align:center;"> 0.6661202 </td>
   <td style="text-align:center;"> 0.6069430 </td>
   <td style="text-align:center;"> 0.4910443 </td>
   <td style="text-align:center;"> 0.3571492 </td>
   <td style="text-align:center;"> 0.3689421 </td>
   <td style="text-align:center;"> 0.4359825 </td>
   <td style="text-align:center;"> 0.4082632 </td>
   <td style="text-align:center;"> 0.5196984 </td>
   <td style="text-align:center;"> 0.5403327 </td>
   <td style="text-align:center;"> 0.5148283 </td>
   <td style="text-align:center;"> 0.3384039 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.8.53.WAV_935-1 </td>
   <td style="text-align:center;"> 0.6602419 </td>
   <td style="text-align:center;"> 0.6680267 </td>
   <td style="text-align:center;"> 0.6937609 </td>
   <td style="text-align:center;"> 0.5854950 </td>
   <td style="text-align:center;"> 0.6446156 </td>
   <td style="text-align:center;"> 0.6603407 </td>
   <td style="text-align:center;"> 0.5976036 </td>
   <td style="text-align:center;"> 0.7922522 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6731222 </td>
   <td style="text-align:center;"> 0.6085192 </td>
   <td style="text-align:center;"> 0.4670023 </td>
   <td style="text-align:center;"> 0.3235150 </td>
   <td style="text-align:center;"> 0.3246283 </td>
   <td style="text-align:center;"> 0.4108837 </td>
   <td style="text-align:center;"> 0.3798096 </td>
   <td style="text-align:center;"> 0.4827565 </td>
   <td style="text-align:center;"> 0.5368642 </td>
   <td style="text-align:center;"> 0.5372974 </td>
   <td style="text-align:center;"> 0.3099306 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.HC1.2013.6.9.9.58.WAV_1016-1 </td>
   <td style="text-align:center;"> 0.7120209 </td>
   <td style="text-align:center;"> 0.6382985 </td>
   <td style="text-align:center;"> 0.6524545 </td>
   <td style="text-align:center;"> 0.5271568 </td>
   <td style="text-align:center;"> 0.6666892 </td>
   <td style="text-align:center;"> 0.6686209 </td>
   <td style="text-align:center;"> 0.6174639 </td>
   <td style="text-align:center;"> 0.6661202 </td>
   <td style="text-align:center;"> 0.6731222 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6369428 </td>
   <td style="text-align:center;"> 0.4849944 </td>
   <td style="text-align:center;"> 0.3460549 </td>
   <td style="text-align:center;"> 0.3528694 </td>
   <td style="text-align:center;"> 0.4096304 </td>
   <td style="text-align:center;"> 0.3615870 </td>
   <td style="text-align:center;"> 0.4781057 </td>
   <td style="text-align:center;"> 0.5221314 </td>
   <td style="text-align:center;"> 0.5234601 </td>
   <td style="text-align:center;"> 0.3694677 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.16.8.53.WAV_1161-1 </td>
   <td style="text-align:center;"> 0.6988743 </td>
   <td style="text-align:center;"> 0.6041628 </td>
   <td style="text-align:center;"> 0.6634098 </td>
   <td style="text-align:center;"> 0.5493029 </td>
   <td style="text-align:center;"> 0.6286261 </td>
   <td style="text-align:center;"> 0.6482925 </td>
   <td style="text-align:center;"> 0.5540561 </td>
   <td style="text-align:center;"> 0.6069430 </td>
   <td style="text-align:center;"> 0.6085192 </td>
   <td style="text-align:center;"> 0.6369428 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.4788152 </td>
   <td style="text-align:center;"> 0.3088765 </td>
   <td style="text-align:center;"> 0.3032929 </td>
   <td style="text-align:center;"> 0.3629339 </td>
   <td style="text-align:center;"> 0.3555858 </td>
   <td style="text-align:center;"> 0.4394982 </td>
   <td style="text-align:center;"> 0.5528358 </td>
   <td style="text-align:center;"> 0.5148888 </td>
   <td style="text-align:center;"> 0.3204284 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.16.8.59.WAV_1197-1 </td>
   <td style="text-align:center;"> 0.5154483 </td>
   <td style="text-align:center;"> 0.5440716 </td>
   <td style="text-align:center;"> 0.4918568 </td>
   <td style="text-align:center;"> 0.4447484 </td>
   <td style="text-align:center;"> 0.5383962 </td>
   <td style="text-align:center;"> 0.4806526 </td>
   <td style="text-align:center;"> 0.4696057 </td>
   <td style="text-align:center;"> 0.4910443 </td>
   <td style="text-align:center;"> 0.4670023 </td>
   <td style="text-align:center;"> 0.4849944 </td>
   <td style="text-align:center;"> 0.4788152 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.5339172 </td>
   <td style="text-align:center;"> 0.5411998 </td>
   <td style="text-align:center;"> 0.5478672 </td>
   <td style="text-align:center;"> 0.4774381 </td>
   <td style="text-align:center;"> 0.4777213 </td>
   <td style="text-align:center;"> 0.5388923 </td>
   <td style="text-align:center;"> 0.5750678 </td>
   <td style="text-align:center;"> 0.4254885 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.16.9.25.WAV_1281-1 </td>
   <td style="text-align:center;"> 0.3852950 </td>
   <td style="text-align:center;"> 0.4152873 </td>
   <td style="text-align:center;"> 0.3583943 </td>
   <td style="text-align:center;"> 0.3008320 </td>
   <td style="text-align:center;"> 0.4215058 </td>
   <td style="text-align:center;"> 0.2966543 </td>
   <td style="text-align:center;"> 0.3984634 </td>
   <td style="text-align:center;"> 0.3571492 </td>
   <td style="text-align:center;"> 0.3235150 </td>
   <td style="text-align:center;"> 0.3460549 </td>
   <td style="text-align:center;"> 0.3088765 </td>
   <td style="text-align:center;"> 0.5339172 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.7558736 </td>
   <td style="text-align:center;"> 0.6355762 </td>
   <td style="text-align:center;"> 0.5668720 </td>
   <td style="text-align:center;"> 0.5191382 </td>
   <td style="text-align:center;"> 0.4390956 </td>
   <td style="text-align:center;"> 0.4809797 </td>
   <td style="text-align:center;"> 0.5021367 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.8.49.WAV_1301-1 </td>
   <td style="text-align:center;"> 0.3887604 </td>
   <td style="text-align:center;"> 0.4516586 </td>
   <td style="text-align:center;"> 0.3840890 </td>
   <td style="text-align:center;"> 0.2865991 </td>
   <td style="text-align:center;"> 0.4205059 </td>
   <td style="text-align:center;"> 0.3188955 </td>
   <td style="text-align:center;"> 0.3979920 </td>
   <td style="text-align:center;"> 0.3689421 </td>
   <td style="text-align:center;"> 0.3246283 </td>
   <td style="text-align:center;"> 0.3528694 </td>
   <td style="text-align:center;"> 0.3032929 </td>
   <td style="text-align:center;"> 0.5411998 </td>
   <td style="text-align:center;"> 0.7558736 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6556991 </td>
   <td style="text-align:center;"> 0.5567713 </td>
   <td style="text-align:center;"> 0.4603450 </td>
   <td style="text-align:center;"> 0.4027855 </td>
   <td style="text-align:center;"> 0.4404790 </td>
   <td style="text-align:center;"> 0.5363211 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.9.00.WAV_1501-1 </td>
   <td style="text-align:center;"> 0.3956447 </td>
   <td style="text-align:center;"> 0.4823688 </td>
   <td style="text-align:center;"> 0.4247754 </td>
   <td style="text-align:center;"> 0.4100052 </td>
   <td style="text-align:center;"> 0.5044780 </td>
   <td style="text-align:center;"> 0.3954393 </td>
   <td style="text-align:center;"> 0.4710913 </td>
   <td style="text-align:center;"> 0.4359825 </td>
   <td style="text-align:center;"> 0.4108837 </td>
   <td style="text-align:center;"> 0.4096304 </td>
   <td style="text-align:center;"> 0.3629339 </td>
   <td style="text-align:center;"> 0.5478672 </td>
   <td style="text-align:center;"> 0.6355762 </td>
   <td style="text-align:center;"> 0.6556991 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.5642896 </td>
   <td style="text-align:center;"> 0.5502287 </td>
   <td style="text-align:center;"> 0.5284762 </td>
   <td style="text-align:center;"> 0.4537784 </td>
   <td style="text-align:center;"> 0.5255706 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.9.02.WAV_1528-1 </td>
   <td style="text-align:center;"> 0.3914653 </td>
   <td style="text-align:center;"> 0.4294063 </td>
   <td style="text-align:center;"> 0.4013482 </td>
   <td style="text-align:center;"> 0.3744821 </td>
   <td style="text-align:center;"> 0.4859131 </td>
   <td style="text-align:center;"> 0.3534321 </td>
   <td style="text-align:center;"> 0.4329344 </td>
   <td style="text-align:center;"> 0.4082632 </td>
   <td style="text-align:center;"> 0.3798096 </td>
   <td style="text-align:center;"> 0.3615870 </td>
   <td style="text-align:center;"> 0.3555858 </td>
   <td style="text-align:center;"> 0.4774381 </td>
   <td style="text-align:center;"> 0.5668720 </td>
   <td style="text-align:center;"> 0.5567713 </td>
   <td style="text-align:center;"> 0.5642896 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.5041113 </td>
   <td style="text-align:center;"> 0.4473097 </td>
   <td style="text-align:center;"> 0.4012941 </td>
   <td style="text-align:center;"> 0.4184304 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.9.05.WAV_1639-1 </td>
   <td style="text-align:center;"> 0.4883395 </td>
   <td style="text-align:center;"> 0.4274496 </td>
   <td style="text-align:center;"> 0.4408986 </td>
   <td style="text-align:center;"> 0.4969475 </td>
   <td style="text-align:center;"> 0.5559871 </td>
   <td style="text-align:center;"> 0.4498219 </td>
   <td style="text-align:center;"> 0.5170149 </td>
   <td style="text-align:center;"> 0.5196984 </td>
   <td style="text-align:center;"> 0.4827565 </td>
   <td style="text-align:center;"> 0.4781057 </td>
   <td style="text-align:center;"> 0.4394982 </td>
   <td style="text-align:center;"> 0.4777213 </td>
   <td style="text-align:center;"> 0.5191382 </td>
   <td style="text-align:center;"> 0.4603450 </td>
   <td style="text-align:center;"> 0.5502287 </td>
   <td style="text-align:center;"> 0.5041113 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.6395395 </td>
   <td style="text-align:center;"> 0.5322242 </td>
   <td style="text-align:center;"> 0.2748930 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.9.09.WAV_1657-1 </td>
   <td style="text-align:center;"> 0.5111078 </td>
   <td style="text-align:center;"> 0.5107089 </td>
   <td style="text-align:center;"> 0.5238786 </td>
   <td style="text-align:center;"> 0.5794219 </td>
   <td style="text-align:center;"> 0.6029589 </td>
   <td style="text-align:center;"> 0.5536003 </td>
   <td style="text-align:center;"> 0.5517801 </td>
   <td style="text-align:center;"> 0.5403327 </td>
   <td style="text-align:center;"> 0.5368642 </td>
   <td style="text-align:center;"> 0.5221314 </td>
   <td style="text-align:center;"> 0.5528358 </td>
   <td style="text-align:center;"> 0.5388923 </td>
   <td style="text-align:center;"> 0.4390956 </td>
   <td style="text-align:center;"> 0.4027855 </td>
   <td style="text-align:center;"> 0.5284762 </td>
   <td style="text-align:center;"> 0.4473097 </td>
   <td style="text-align:center;"> 0.6395395 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.5961749 </td>
   <td style="text-align:center;"> 0.2524172 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 0.TR2.2013.4.17.9.18.WAV_1722-1 </td>
   <td style="text-align:center;"> 0.5291018 </td>
   <td style="text-align:center;"> 0.4603019 </td>
   <td style="text-align:center;"> 0.4610690 </td>
   <td style="text-align:center;"> 0.5094645 </td>
   <td style="text-align:center;"> 0.5223915 </td>
   <td style="text-align:center;"> 0.4863099 </td>
   <td style="text-align:center;"> 0.4455741 </td>
   <td style="text-align:center;"> 0.5148283 </td>
   <td style="text-align:center;"> 0.5372974 </td>
   <td style="text-align:center;"> 0.5234601 </td>
   <td style="text-align:center;"> 0.5148888 </td>
   <td style="text-align:center;"> 0.5750678 </td>
   <td style="text-align:center;"> 0.4809797 </td>
   <td style="text-align:center;"> 0.4404790 </td>
   <td style="text-align:center;"> 0.4537784 </td>
   <td style="text-align:center;"> 0.4012941 </td>
   <td style="text-align:center;"> 0.5322242 </td>
   <td style="text-align:center;"> 0.5961749 </td>
   <td style="text-align:center;"> 1.0000000 </td>
   <td style="text-align:center;"> 0.2312305 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 108.LOC.2013.3.26.8.15.WAV_1810-1 </td>
   <td style="text-align:center;"> 0.3778123 </td>
   <td style="text-align:center;"> 0.4668047 </td>
   <td style="text-align:center;"> 0.4186119 </td>
   <td style="text-align:center;"> 0.1939822 </td>
   <td style="text-align:center;"> 0.3528862 </td>
   <td style="text-align:center;"> 0.2877853 </td>
   <td style="text-align:center;"> 0.3766514 </td>
   <td style="text-align:center;"> 0.3384039 </td>
   <td style="text-align:center;"> 0.3099306 </td>
   <td style="text-align:center;"> 0.3694677 </td>
   <td style="text-align:center;"> 0.3204284 </td>
   <td style="text-align:center;"> 0.4254885 </td>
   <td style="text-align:center;"> 0.5021367 </td>
   <td style="text-align:center;"> 0.5363211 </td>
   <td style="text-align:center;"> 0.5255706 </td>
   <td style="text-align:center;"> 0.4184304 </td>
   <td style="text-align:center;"> 0.2748930 </td>
   <td style="text-align:center;"> 0.2524172 </td>
   <td style="text-align:center;"> 0.2312305 </td>
   <td style="text-align:center;"> 1.0000000 </td>
  </tr>
</tbody>
</table></div>

Now we can input the cross-correlation (di)similarities in a mantel to directly test our hypothesis. But first, we need an second matrix representing lek membership. It must be a pairwise matrix in which 0 will denote pairs of individuals that belong to the same lek and 1 pairs that belong to different leks. The following function creates the binary matrix:

{% highlight r %}
#function to create group membership binary matrix
bi_mats <- function(X, labels) {
  
  # create empty matrix to store memebership matrix
  mat <- matrix(nrow = ncol(X), ncol = ncol(X))
 
  # add labels to row and col names
  rownames(mat) <- colnames(mat) <- labels
  
  # add 0 if same lek and 1 if else 
  out <- lapply(1:(length(labels) - 1), function(i){
  sapply((i + 1):length(labels), function(j) 
    if (labels[i] == labels[j]) 0 else 1)  
    })

  # add to mat
  mat[lower.tri(mat)] <- unlist(out)

  # retunr as distance matrix
  return(as.dist(mat))
  }
{% endhighlight %}

The function takes as arguments the cross-correlation similarity matrix and a label indicating lek membership:

{% highlight r %}
# create lek membership from column names
lbls <- sapply(strsplit(colnames(xc_mat), ".", fixed = TRUE), "[[", 2)

# create binary matrix
lek_bi_mat <- bi_mats(xc_mat, lbls)

# look at the first 15 rows/cols
as.matrix(lek_bi_mat)[1:15, 1:15]
{% endhighlight %}



{% highlight text %}
##     HC1 HC1 HC1 HC1 HC1 HC1 HC1 HC1 HC1 HC1 TR2 TR2 TR2 TR2 TR2
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## HC1   0   0   0   0   0   0   0   0   0   0   1   1   1   1   1
## TR2   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0
## TR2   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0
## TR2   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0
## TR2   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0
## TR2   1   1   1   1   1   1   1   1   1   1   0   0   0   0   0
{% endhighlight %}

The 2 matrices are then input into a Mantel test to evaluate if acoustic similarity is higher within than between leks. Note that the cross-correlation matrix is transformed into a distance matrix by subtracting it from 1:

{% highlight r %}
# install vegan if necessary
library(vegan)

# convert xcorr mat to distance
xc_dist <- as.dist(1 - xc_mat)

# run mantel test
mantel(xc_dist, lek_bi_mat, permutations = 10000)
{% endhighlight %}



{% highlight text %}
## 
## Mantel statistic based on Pearson's product-moment correlation 
## 
## Call:
## mantel(xdis = xc_dist, ydis = lek_bi_mat, permutations = 10000) 
## 
## Mantel statistic r: 0.3796 
##       Significance: 9.999e-05 
## 
## Upper quantiles of permutations (null model):
##    90%    95%  97.5%    99% 
## 0.0309 0.0416 0.0517 0.0640 
## Permutation: free
## Number of permutations: 10000
{% endhighlight %}

That's a pretty solid association between lek membership and acoustic similarity, r = 0.37. So there is a lek level acoustic signature.

## Individual signature

We can use the same approach to test for signatures at other levels, for instance, at the individual level. Let's first pick up the lek with the highest number of individuals:

{% highlight r %}
colSums(table(lbh_est$Bird.ID, lbh_est$Lek))
{% endhighlight %}



{% highlight text %}
##  CCL  HC1  LOC  SJA  SUR  TR2 
##  529 1115  779 1584 3015  624
{% endhighlight %}

Lek "SUR" is the one with more birds (n = 14). So we will keep only the recordings from that lek. We will also keep the 5 highest signal-to-noise ratio songs for each individual to shrink the data set a bit and speed up the analysis:

{% highlight r %}
# keep only SUR swongs
sur_est <- lbh_est[lbh_est$Lek == "SUR", ]

# check count
table(sur_est$lek.song.type)
{% endhighlight %}



{% highlight text %}
## 
##  SUR-L SUR-L1  SUR-O SUR-O1 
##    411   1215   1189    200
{% endhighlight %}



{% highlight r %}
# subset ext. sel. tab.
sub_sur_est <- sur_est[ave(x = sur_est$SNR, sur_est$Bird.ID, FUN = function(x) rank(x, ties.method = "first")) <= 5, ]

# check count
table(sub_sur_est$Bird.ID)
{% endhighlight %}



{% highlight text %}
## 
## 135 143 148 152 165 176 177 178 179 180  36  54   9  95 
##   5   5   5   5   5   5   5   5   5   5   5   5   5   5
{% endhighlight %}

Cross-correlation can now be run:

{% highlight r %}
xc_ind_mat <- x_corr(sub_sur_est)
{% endhighlight %}



Again, we need a pairwise binary matrix indicating if songs belong to the same or to different individuals:

{% highlight r %}
# create binary matrix
ind_bi_mat <- bi_mats(xc_ind_mat, sub_sur_est$Bird.ID)
{% endhighlight %}

These songs also belong to different song types within lek "SUR". So we must take this other level of variation into account. This can be done by using an additional song-type membership binary matrix as a third variable in a partial mantel test:

{% highlight r %}
# create binary matrix
st_bi_mat <- bi_mats(xc_ind_mat, sub_sur_est$lek.song.type)
{% endhighlight %}

And then just run the cross-correlation as we did above:

{% highlight r %}
# convert xcorr mat to distance
xc_ind_dist <- as.dist(1 - xc_ind_mat)

# run mantel test
mantel.partial(xc_ind_dist, ind_bi_mat, st_bi_mat, 
               permutations = 10000)
{% endhighlight %}



{% highlight text %}
## 
## Partial Mantel statistic based on Pearson's product-moment correlation 
## 
## Call:
## mantel.partial(xdis = xc_ind_dist, ydis = ind_bi_mat, zdis = st_bi_mat,      permutations = 10000) 
## 
## Mantel statistic r: 0.382 
##       Significance: 9.999e-05 
## 
## Upper quantiles of permutations (null model):
##    90%    95%  97.5%    99% 
## 0.0255 0.0340 0.0421 0.0510 
## Permutation: free
## Number of permutations: 10000
{% endhighlight %}

There is a pretty high correlation, which suggests strong individual signatures. 

That's it!


---


<font size="4"><b>Session information</b></font>


{% highlight text %}
## R version 3.6.1 (2019-07-05)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 19.04
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.8.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.8.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=es_CR.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=es_CR.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=es_CR.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=es_CR.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] vegan_2.5-5        lattice_0.20-38    permute_0.9-5     
## [4] kableExtra_1.1.0   warbleR_1.1.16     NatureSounds_1.0.1
## [7] seewave_2.1.3      tuneR_1.3.3        maps_3.3.0        
## 
## loaded via a namespace (and not attached):
##  [1] xfun_0.7          pbapply_1.4-0     splines_3.6.1    
##  [4] colorspace_1.4-1  htmltools_0.3.6   viridisLite_0.3.0
##  [7] mgcv_1.8-28       rlang_0.3.4       pracma_2.2.5     
## [10] pillar_1.4.0      glue_1.3.1        jpeg_0.1-8       
## [13] stringr_1.4.0     munsell_0.5.0     rvest_0.3.3      
## [16] evaluate_0.14     knitr_1.23        fftw_1.0-5       
## [19] parallel_3.6.1    highr_0.8         Rcpp_1.0.1       
## [22] readr_1.3.1       scales_1.0.0      webshot_0.5.1    
## [25] soundgen_1.4.0    Sim.DiffProc_4.3  Deriv_3.8.5      
## [28] rjson_0.2.20      hms_0.4.2         packrat_0.5.0    
## [31] digest_0.6.19     stringi_1.4.3     dtw_1.20-1       
## [34] grid_3.6.1        tools_3.6.1       bitops_1.0-6     
## [37] magrittr_1.5      RCurl_1.95-4.12   proxy_0.4-23     
## [40] tibble_2.1.1      cluster_2.1.0     crayon_1.3.4     
## [43] pkgconfig_2.0.2   Matrix_1.2-17     MASS_7.3-51.4    
## [46] xml2_1.2.0        rmarkdown_1.13    httr_1.4.0       
## [49] rstudioapi_0.10   iterators_1.0.10  R6_2.4.0         
## [52] signal_0.7-6      nlme_3.1-140      compiler_3.6.1
{% endhighlight %}

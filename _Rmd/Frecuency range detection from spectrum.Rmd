---
title: "Frequency range detection from spectrum"
author: "Marcelo Araya-Salas"
date: "2017-05-08"
output: 
  md_document:
    variant: markdown_github
---

In bioacoustics we are often interested in measuring the frequency range of acoustic signals. This is typically done by drawing boxes in Raven/Syrinx/Avisoft. An alternative way, and potentially less subjective, is to infer the range from the energy distribution in the frequency domain applying amplitude thresholds on spectrums. 

I have added two new functions to [warbleR](https://cran.r-project.org/package=warbleR) that do exactly that:

* `frange.detec`: detects the frequency range of signals in wave objects (like a [seewave](https://cran.r-project.org/package=seewave) function). Can produce image files in the working directory if `img = TRUE`.

* `frange`: applies 'frange.detec' function iteratively on signals listed in a selection table.  If `plot = TRUE` a graph including a spectrogram and a frequency spectrum is produced.

This how they work. But first Load/install [warbleR](https://cran.r-project.org/package=warbleR):
 
```{r load libraries and functions, eval = T}

if(!require(devtools)) install.packages("devtools")

devtools::install_github("maRce10/warbleR")

library("warbleR")

if(!require(monitoR)) install.packages("monitoR")

```

The following is the same code found in the paper. Download recordings and run detection and acoustic analysis:

```{r, eval = F}

setwd(tempdir())

# Query Xeno-Canto for metadata using genus and species as keywords
Phae.stri <- querxc(qword = "nr:154074", download = TRUE)

# Convert mp3 to wav format
# Simultaneously lower sampling rate for more speed in following analyses
  mp32wav(samp.rate = 22.05)

```

```{r save ts data,eval = F, echo = F}
Phae.stri <- readWave("/tmp/RtmpmZOJaU/Phaethornis-striigularis-154074.wav")

saveRDS(Phae.stri, "~/Dropbox/Websites/Blog/Phae.stri.RDS")


```

```{r, eval= T, echo=F}
Phae.stri <- readRDS("~/Dropbox/Websites/Blog/Phae.stri.RDS")
# Phae.hisnr <- readRDS("~/Dropbox/Websites/Blog/lbh_hi_snr_sels_for_blog.RDS")

writeWave(Phae.stri, "Phaethornis-striigularis-154074.wav")



```


```{r set aesthetics for plotting, eval = T}

writeWave(readWave("Phaethornis-striigularis-154074.wav", from = 6, to = 16, units = "seconds"), "Phaethornis-striigularis-154074-CUT.wav")

unlink("Phaethornis-striigularis-154074.wav")

ad <- autodetec(wl = 200, flim = c(3.5, 10.5), threshold = 3.5, ssmooth = 1200, bp = c(4, 9.6), pb = FALSE, ls = T, sxrow = 1, rows = 10, xl = 4, mindur = 0.1, maxdur = 0.25)

nrow(ad)

catalog(ad,nrow = 6, ncol = 4, mar = 0.01, flim = c(3.5, 10.5), labels = "selec", pal = reverse.heat.colors)

```


`frange.detec` works on wave objects. In this example we use it to detect the frequency range of the first selection in "ad". But first the selection was to be read as a wave object into R: 

```{r}

w1 <- readWave(as.character(ad$sound.files[1]), from = ad$start[1], to = ad$end[1], units = "seconds")

frange.detec(w1, bp = c(2, 9.6), fsmooth = 0.5, fast.spec = T, pal = monitoR::gray.3, ovlp = 90, wl = 200, threshold = 5)


```


```{r}

for(i in 1:23)
{wv <- readWave(as.character(ad$sound.files[i]), from = ad$start[i], to = ad$end[i], units = "seconds")

frange.detec(wv, bp = c(2, 12), fsmooth = 1, fast.spec = T, pal = monitoR::gray.3, ovlp = 95, wl = 200, threshold = 8, flim = c(0, 13), main = paste("selection", i))

Sys.sleep(0.8)
}
```

In most cases the detection is decent. However, there are some issues with signals with a lot of amplitude modulation (variation in amplitude across the signal). Some parameter tweeking will be required to improve the detections. 


Frequency range can be calculated for all selection in a selection table using `frange`:

```{r}

fr.ad <- frange(X = ad, bp = c(2, 12), fsmooth = 0.001, ovlp = 95, wl = 200, threshold = 10, img = F)

View(fr.ad)

```

The range can be used as a band pass in further analysis that required frequency detection as in `trackfreqs`, `dfts` or `specan`:

```{r}
for(i in 1:23)
trackfreqs(X = fr.ad, wl = 200, flim = c(2, 12), bp = "frange", pal = monitoR::gray.3, fast.spec = TRUE, contour = "df", ovlp = 90, pb = FALSE, threshold = 15, line = F, freq.continuity = 0.2, clip.edges = 2, type = "l")


```




That's it!

